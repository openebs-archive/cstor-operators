dist: bionic

language: go

go:
  - 1.13.x

env:
  global:
   - ARCH=$(go env GOARCH)
   - CHANGE_MINIKUBE_NONE_USER=true
   - MINIKUBE_WANTUPDATENOTIFICATION=false
   - MINIKUBE_WANTREPORTERRORPROMPT=false
   - MINIKUBE_HOME=$HOME
   - CHANGE_MINIKUBE_NONE_USER=true
   - KUBECONFIG=$HOME/.kube/config

services:
  - docker

jobs:
  include:
    - os: linux
      arch: amd64

addons:
  apt:
    update: true

install:
  - if [ "$TRAVIS_BUILD_DIR" != "$GOPATH/src/github.com/openebs/cstor-operators" ]; then
      mkdir -p $GOPATH/src/github.com/openebs/;
      mv $TRAVIS_BUILD_DIR $GOPATH/src/github.com/openebs;
      cd $GOPATH/src/github.com/openebs/cstor-operators;
    fi

  - make deps

before_script: # TODO add golangci yaml config
  - curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s -- -b $(go env GOPATH)/bin v1.25.0
  - if [ "$TRAVIS_CPU_ARCH" == "amd64" ]; then
      curl -Lo kubectl https://storage.googleapis.com/kubernetes-release/release/v1.18.1/bin/linux/amd64/kubectl && chmod +x kubectl && sudo mv kubectl /usr/local/bin/;
      curl -Lo minikube https://storage.googleapis.com/minikube/releases/v1.8.1/minikube-linux-amd64 && chmod +x minikube && sudo mv minikube /usr/local/bin/;
      mkdir -p $HOME/.kube $HOME/.minikube;
      touch $KUBECONFIG;
      sudo minikube start --profile=minikube --vm-driver=none --kubernetes-version=v1.18.1;
      minikube update-context --profile=minikube;
      sudo chown -R travis: /home/travis/.minikube/;
      eval "$(minikube docker-env --profile=minikube)" && export DOCKER_CLI='docker';
      JSONPATH='{range .items[*]}{@.metadata.name}:{range @.status.conditions[*]}{@.type}={@.status};{end}{end}'; until kubectl get nodes -o jsonpath="$JSONPATH" 2>&1 | grep -q "Ready=True"; do sleep 1; done;
    fi
script:
  - make test
  - if [ "$TRAVIS_CPU_ARCH" == "amd64" ]; then
      make all.amd64;
    fi

after_success:
  - make deploy-images

notifications:
  email:
    recipients:
      - prateek.pandey@mayadata.io
      - ashutosh.kumar@mayadata.io
